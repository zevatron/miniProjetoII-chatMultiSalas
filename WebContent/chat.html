<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Websocket Chat</title>

<link href="chat.css" rel="stylesheet">
<link
	href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/materia/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-B7n8QuRe6UtnoLRAwGkku55zwnr4h8whf+ThXUwwlP9SaeNzHlGR4cOOuEZVMYOL"
	crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
	integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
	crossorigin="anonymous"></script>
<script>
	$(function() {
		var params = (new URL(document.location)).searchParams;

		var sala = params.get("sala");
		var user = params.get("nickname");

		var socket = new WebSocket("ws://" + document.location.host
				+ "/chatMultiSalas/" + sala + "/" + user);
		
		atualizarNome(user);
		$('#navBarTitle').text('ChatMultiSalas - ' + sala);

		function atualizarNome(nome) {
			if (socket) {
				user = nome;
				$('#navbarDropdownMenuLinkUser').text(nome);
			}			
		}
		

		$('#formMessage').submit(function() {
			if ($('#m').val().length > 0) {
				if($('#listUsers').val()[0] != "Todos"){
					var msg = "send -u " + $('#listUsers').val()[0] + " " + $('#m').val();
				}else{
					var msg = "send " + $('#m').val();					
				}
				socket.send(msg);
				$('#m').val('');
			}
			return false;
		});
		
		$('#formRename').submit(function() {
			if ($('#rename').val().length > 0) {
				var msg = "rename " + $('#rename').val();
				atualizarNome($('#rename').val());
				socket.send(msg);
				$('#rename').val('');
				$('#exampleModal').modal('toggle');
			}
			return false;
		});
		
		

		$('.list-group li').click(function(e) {
			e.preventDefault()

			$that = $(this);

			$that.parent().find('li').removeClass('active');
			$that.addClass('active');
		});

		socket.onmessage = function(event) {
			msg = event.data;
			if (msg.split(' ')[0] == 'user-list') {
				users = msg.slice(11, -1).split(',');
				$('#listUsers').empty();
				$('#listUsers').append($('<option>').text('Todos')
						.addClass('list-group-item list-group-item-action')
						.attr('selected','selected'));
				for (i = 0; i < users.length; i++) {
					$('#listUsers').append($('<option>')
							.text(users[i]).addClass('list-group-item list-group-item-action')
							.val(users[i][0]==' ' ? users[i].slice(1) : users[i] ));
				}
			}else if(msg.split(' ')[0] == 'rename'){
				atualizarNome(msg.slice(7, -1));
			} else {
				$('#messages').append($('<li>').text(msg));
			}
		};

	});
</script>
</head>
<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
		<a id="navBarTitle" class="navbar-brand" href="#">ChatMultiSalas</a>


		<ul class="nav navbar-nav ml-auto">
			<li class="nav-item dropdown"><a
				class="nav-link dropdown-toggle" href="#"
				id="navbarDropdownMenuLinkUser" data-toggle="dropdown"
				aria-haspopup="true" aria-expanded="false"> </a>
				<div class="dropdown-menu dropdown-menu-right"
					aria-labelledby="navbarDropdownMenuLinkUser">
					<a class="dropdown-item button" href="#" data-toggle="modal"
						data-target="#exampleModal">Renomear usu치rio</a> <a
						class="dropdown-item" href="index.html">Sair da sala</a>
					<!-- Button trigger modal -->

				</div>
			</li>

		</ul>

		
	</nav>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-9">
				<ul id="messages"></ul>

			</div>
			<div class="col-md-3" id="users">
				<div class="alert alert-dismissible alert-info">
					<h3>Usu치rios</h3>
					<p>Selecione o usu치rio para falar <b> reservadamente </b> com ele.</p>
				</div>
				<div class="list-group" >
					<select  multiple="multiple" class="form-control list-group" id="listUsers">
						
					</select>
				</div>
				
				<!-- Modal -->
				<div class="modal fade" id="exampleModal" tabindex="-1"
					role="dialog" aria-labelledby="exampleModalLabel"
					aria-hidden="true">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel">Alterar nome do usu치rio</h5>
								<button type="button" class="close" data-dismiss="modal"
									aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<form action="" id="formRename">
							<div class="modal-body">
								<label class="col-form-label" for="renameUser">Novo Nickname</label> 
								<input id="rename" class="form-control" placeholder="" name="renameUser" autofocus="autofocus">
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary"
									data-dismiss="modal">Fechar</button>
								<button type="submit" class="btn btn-primary" >Alterar</button>
							</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<form action="" id="formMessage">
		<input id="m" autocomplete="off" autofocus="autofocus" />
		<button type="submit" class="btn btn-primary">Enviar</button>
	</form>
</body>
</html>